import{h as n,j as s}from"./codemirror-core-vkcnXJgD.js";import{b as T,k as $,V as W,v as B,x as H,y as q,z as G,A as Q,B as X,P as Y}from"./index-CRxYmROf.js";import{J as i}from"./react-dom-Cz0lLOn1.js";import{a as Z}from"./index-CT80i5B1.js";import{e as ee}from"./index-CJT7zyU5.js";import{s as J}from"./chunk-J6JGI6RM-CcOOoqKk.js";import{c as se}from"./chunk-NAV3ZXLI-Cx7sjRMR.js";import{l as ae,m as te}from"./index-Ct0bcwxX.js";import{D as le}from"./container-CayvaCdb.js";import{P as N}from"./plugin_manager-BHhkeCxq.js";import{u as re}from"./use-dialog-Br2F93aG.js";import{i as A}from"./chunk-2QAN2V2R-DUfyhebH.js";import{s as U,l as V}from"./chunk-KVDW62ZT-7LdzXPwy.js";import"./iconBase-DqQMrcxU.js";import"./chunk-EN4B57RQ-DpwResUR.js";import"./chunk-UX7UMZL5-D0R1-FPm.js";import"./chunk-M3MASYO7-Cm5fw87L.js";import"./chunk-5PILOUBS-0YCBWX_5.js";import"./chunk-SLABUSGS-Dy5CjS7O.js";import"./Item-CdZrGEbe.js";import"./chunk-AXSF7SRE-CGODruUG.js";import"./chunk-WQVQ7P2I-BFZSGHT9.js";const ne=({data:k,onToggleStatus:C,onUninstall:u,onConfig:E,hasConfig:P=!1})=>{const{name:p,version:f,author:v,description:_,status:y}=k,F=y==="active",[z,m]=n.useState(!1),h=()=>{m(!0),C().finally(()=>m(!1))},R=()=>{m(!0),u().finally(()=>m(!1))};return s.jsx(le,{className:"w-full max-w-[420px]",action:s.jsxs("div",{className:"flex flex-col gap-2 w-full",children:[s.jsx("div",{className:"flex gap-2 w-full",children:s.jsx(T,{fullWidth:!0,radius:"full",size:"sm",variant:"flat",className:"flex-1 bg-default-100 dark:bg-default-50 text-default-600 font-medium hover:bg-danger/20 hover:text-danger transition-colors",startContent:s.jsx(ae,{size:16}),onPress:R,isDisabled:z,children:"å¸è½½"})}),P&&s.jsx(T,{fullWidth:!0,radius:"full",size:"sm",variant:"flat",className:"bg-default-100 dark:bg-default-50 text-default-600 font-medium hover:bg-secondary/20 hover:text-secondary transition-colors",startContent:s.jsx(te,{size:16}),onPress:E,children:"é…ç½®"})]}),enableSwitch:s.jsx(J,{isDisabled:z,isSelected:F,onChange:h,classNames:{wrapper:"group-data-[selected=true]:bg-primary-400"}}),title:p,tag:s.jsx(se,{className:"ml-auto",color:y==="active"?"success":y==="stopped"?"warning":"default",size:"sm",variant:"flat",children:y==="active"?"è¿è¡Œä¸­":y==="stopped"?"å·²åœæ­¢":"å·²ç¦ç”¨"}),children:s.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[s.jsxs("div",{className:"flex flex-col gap-1 p-3 bg-default-100/50 dark:bg-white/10 rounded-xl border border-transparent hover:border-default-200 transition-colors",children:[s.jsx("span",{className:"text-xs text-default-500 dark:text-white/50 font-medium tracking-wide",children:"ç‰ˆæœ¬"}),s.jsx("div",{className:"text-sm font-medium text-default-700 dark:text-white/90 truncate",children:f})]}),s.jsxs("div",{className:"flex flex-col gap-1 p-3 bg-default-100/50 dark:bg-white/10 rounded-xl border border-transparent hover:border-default-200 transition-colors",children:[s.jsx("span",{className:"text-xs text-default-500 dark:text-white/50 font-medium tracking-wide",children:"ä½œè€…"}),s.jsx("div",{className:"text-sm font-medium text-default-700 dark:text-white/90 truncate",children:v||"æœªçŸ¥"})]}),s.jsxs("div",{className:"col-span-2 flex flex-col gap-1 p-3 bg-default-100/50 dark:bg-white/10 rounded-xl border border-transparent hover:border-default-200 transition-colors",children:[s.jsx("span",{className:"text-xs text-default-500 dark:text-white/50 font-medium tracking-wide",children:"æè¿°"}),s.jsx("div",{className:"text-sm font-medium text-default-700 dark:text-white/90 break-words line-clamp-2",children:_||"æš‚æ— æè¿°"})]})]})})};function ce({isOpen:k,onOpenChange:C,pluginId:u}){const[E,P]=n.useState(!1),[p,f]=n.useState([]),[v,_]=n.useState({}),[y,F]=n.useState(!1),[z,m]=n.useState(!1),[h,R]=n.useState(null),[L,M]=n.useState(!1),S=n.useRef(null),I=n.useRef({});n.useEffect(()=>{I.current=v},[v]);const t=n.useCallback(e=>{switch(e.type){case"full":e.schema&&f(e.schema);break;case"updateField":e.key&&e.field&&f(r=>r.map(a=>a.key===e.key?{...a,...e.field}:a));break;case"removeField":e.key&&f(r=>r.filter(a=>a.key!==e.key));break;case"addField":e.field&&f(r=>{const a=e.field,d=r.findIndex(l=>l.key===a.key);if(d!==-1){const l=[...r];return l[d]={...l[d],...a},l}if(e.afterKey){const l=r.findIndex(c=>c.key===e.afterKey);if(l!==-1){const c=[...r];return c.splice(l+1,0,a),c}}return[...r,a]});break;case"showField":e.key&&f(r=>r.map(a=>a.key===e.key?{...a,hidden:!1}:a));break;case"hideField":e.key&&f(r=>r.map(a=>a.key===e.key?{...a,hidden:!0}:a));break}},[]),o=n.useCallback(e=>{S.current&&S.current.close();const r=localStorage.getItem($.token);if(!r){console.warn("æœªç™»å½•ï¼Œæ— æ³•å»ºç«‹ SSE è¿æ¥");return}const a=JSON.parse(r),d=N.getConfigSSEUrl(u,e),l=new W.EventSourcePolyfill(d,{headers:{Authorization:`Bearer ${a}`,Accept:"text/event-stream"},withCredentials:!0});S.current=l,l.addEventListener("connected",c=>{const g=JSON.parse(c.data);R(g.sessionId),M(!0)}),l.addEventListener("schema",c=>{const g=JSON.parse(c.data);t(g)}),l.addEventListener("error",c=>{try{const g=JSON.parse(c.data);i.error("æ’ä»¶é”™è¯¯: "+g.message)}catch{M(!1)}}),l.onerror=()=>{M(!1)}},[u,t]),x=n.useCallback(()=>{S.current&&(S.current.close(),S.current=null),R(null),M(!1)},[]);n.useEffect(()=>(k&&u&&j(),()=>{x()}),[k,u,x]);const j=async()=>{P(!0),f([]),_({}),m(!1),x();try{const e=await N.getPluginConfig(u);f(e.schema||[]),_(e.config||{}),m(!!e.supportReactive),e.supportReactive&&o(e.config||{})}catch(e){i.error("åŠ è½½é…ç½®å¤±è´¥: "+e.message)}finally{P(!1)}},b=async()=>{F(!0);try{await N.setPluginConfig(u,v),i.success("Configuration saved"),C()}catch(e){i.error("Save failed: "+e.message)}finally{F(!1)}},w=n.useCallback((e,r)=>{_(a=>{const d={...a,[e]:r},l=p.find(c=>c.key===e);return l!=null&&l.reactive&&h&&L&&N.notifyConfigChange(u,h,e,r,d).catch(c=>console.error("é€šçŸ¥é…ç½®å˜åŒ–å¤±è´¥:",c)),d})},[p,h,L,u]),K=e=>{const r=v[e.key]??e.default;switch(e.type){case"string":return s.jsx(A,{label:e.label,placeholder:e.placeholder||e.description,value:r||"",onValueChange:a=>w(e.key,a),description:e.description,className:"mb-4"},e.key);case"number":return s.jsx(A,{type:"number",label:e.label,placeholder:e.placeholder||e.description,value:String(r??0),onValueChange:a=>w(e.key,Number(a)),description:e.description,className:"mb-4"},e.key);case"boolean":return s.jsxs("div",{className:"flex justify-between items-center mb-4 p-2 bg-default-100 rounded-lg",children:[s.jsxs("div",{className:"flex flex-col",children:[s.jsx("span",{className:"text-small",children:e.label}),e.description&&s.jsx("span",{className:"text-tiny text-default-500",children:e.description})]}),s.jsx(J,{isSelected:!!r,onValueChange:a=>w(e.key,a)})]},e.key);case"select":{const a=r!==void 0?String(r):void 0,d=e.options||[];return s.jsx(U,{label:e.label,placeholder:e.placeholder||"Select an option",selectedKeys:a?[a]:[],onSelectionChange:l=>{const c=Array.from(l)[0],g=d.find(D=>String(D.value)===c);w(e.key,g?g.value:c)},description:e.description,className:"mb-4",children:d.map(l=>s.jsx(V,{textValue:l.label,children:l.label},String(l.value)))},e.key)}case"multi-select":{const a=Array.isArray(r)?r.map(String):[],d=e.options||[];return s.jsx(U,{label:e.label,placeholder:e.placeholder||"Select options",selectionMode:"multiple",selectedKeys:new Set(a),onSelectionChange:l=>{const c=Array.from(l).map(g=>{const D=d.find(O=>String(O.value)===g);return D?D.value:g});w(e.key,c)},description:e.description,className:"mb-4",children:d.map(l=>s.jsx(V,{textValue:l.label,children:l.label},String(l.value)))},e.key)}case"html":return s.jsxs("div",{className:"mb-4",children:[e.label&&s.jsx("h4",{className:"text-small font-bold mb-1",children:e.label}),s.jsx("div",{dangerouslySetInnerHTML:{__html:e.default||""},className:"prose dark:prose-invert max-w-none"}),e.description&&s.jsx("p",{className:"text-tiny text-default-500 mt-1",children:e.description})]},e.key);case"text":return s.jsxs("div",{className:"mb-4",children:[e.label&&s.jsx("h4",{className:"text-small font-bold mb-1",children:e.label}),s.jsx("div",{className:"whitespace-pre-wrap text-default-700",children:e.default||""}),e.description&&s.jsx("p",{className:"text-tiny text-default-500 mt-1",children:e.description})]},e.key);default:return null}};return s.jsx(B,{isOpen:k,onOpenChange:C,size:"2xl",scrollBehavior:"inside",children:s.jsx(H,{children:e=>s.jsxs(s.Fragment,{children:[s.jsx(q,{className:"flex flex-col gap-1",children:s.jsxs("div",{className:"flex items-center gap-2",children:["æ’ä»¶é…ç½®: ",u,z&&s.jsx("span",{className:`text-tiny px-2 py-0.5 rounded ${L?"bg-success-100 text-success-600":"bg-warning-100 text-warning-600"}`,children:L?"å·²è¿æ¥":"æœªè¿æ¥"})]})}),s.jsx(G,{children:E?s.jsx("div",{className:"flex justify-center p-8",children:"Loading configuration..."}):s.jsx("div",{className:"flex flex-col gap-2",children:p.length===0?s.jsx("div",{className:"text-center text-default-500",children:"No configuration schema available."}):p.filter(r=>!r.hidden).map(K)})}),s.jsxs(Q,{children:[s.jsx(T,{color:"danger",variant:"light",onPress:e,children:"Close"}),s.jsx(T,{color:"primary",onPress:b,isLoading:y,children:"Save"})]})]})})})}function Fe(){const[k,C]=n.useState([]),[u,E]=n.useState(!1),[P,p]=n.useState(!1),f=re(),{isOpen:v,onOpen:_,onOpenChange:y}=X(),[F,z]=n.useState(""),m=n.useRef(null),h=async()=>{E(!0),p(!1);try{const t=await N.getPluginList();t.pluginManagerNotFound?(p(!0),C([])):C(t.plugins)}catch(t){i.error(t.message)}finally{E(!1)}};n.useEffect(()=>{h()},[]);const R=async t=>{const o=t.status!=="active",x=o?"å¯ç”¨":"ç¦ç”¨",j=i.loading(`${x}ä¸­...`);try{await N.setPluginStatus(t.id,o),i.success(`${x}æˆåŠŸ`,{id:j}),h()}catch(b){i.error(b.message,{id:j})}},L=async t=>new Promise((o,x)=>{f.confirm({title:"å¸è½½æ’ä»¶",content:s.jsxs("div",{className:"flex flex-col gap-2",children:[s.jsxs("p",{children:["ç¡®å®šè¦å¸è½½æ’ä»¶ã€Œ",t.name,"ã€å—? æ­¤æ“ä½œä¸å¯æ¢å¤ã€‚"]}),s.jsx("p",{className:"text-small text-default-500",children:"å¦‚æœæ’ä»¶åˆ›å»ºäº†æ•°æ®æ–‡ä»¶ï¼Œæ˜¯å¦ä¸€å¹¶åˆ é™¤ï¼Ÿ"})]}),onConfirm:async()=>{const j=window.confirm(`æ˜¯å¦åŒæ—¶æ¸…ç†æ’ä»¶ã€Œ${t.name}ã€çš„æ•°æ®æ–‡ä»¶ï¼Ÿ
ç‚¹å‡»â€œç¡®å®šâ€æ¸…ç†æ•°æ®ï¼Œç‚¹å‡»â€œå–æ¶ˆâ€ä»…å¸è½½æ’ä»¶ã€‚`),b=i.loading("å¸è½½ä¸­...");try{await N.uninstallPlugin(t.id,j),i.success("å¸è½½æˆåŠŸ",{id:b}),h(),o()}catch(w){i.error(w.message,{id:b}),x(w)}},onCancel:()=>{o()}})}),M=t=>{z(t.id),_()},S=()=>{var t;if(P){f.confirm({title:"æ’ä»¶ç®¡ç†å™¨æœªåŠ è½½",content:s.jsxs("div",{className:"space-y-2",children:[s.jsx("p",{className:"text-sm text-default-600",children:"æ’ä»¶ç®¡ç†å™¨å°šæœªåŠ è½½ï¼Œæ— æ³•å¯¼å…¥æ’ä»¶ã€‚"}),s.jsx("p",{className:"text-sm text-default-600",children:"æ˜¯å¦ç«‹å³æ³¨å†Œæ’ä»¶ç®¡ç†å™¨ï¼Ÿ"})]}),confirmText:"æ³¨å†Œæ’ä»¶ç®¡ç†å™¨",cancelText:"å–æ¶ˆ",onConfirm:async()=>{var o;try{await N.registerPluginManager(),i.success("æ’ä»¶ç®¡ç†å™¨æ³¨å†ŒæˆåŠŸ"),p(!1),(o=m.current)==null||o.click()}catch(x){i.error("æ³¨å†Œå¤±è´¥: "+x.message)}}});return}(t=m.current)==null||t.click()},I=async t=>{var j;const o=(j=t.target.files)==null?void 0:j[0];if(!o)return;if(t.target.value="",!o.name.endsWith(".zip")){i.error("è¯·é€‰æ‹© .zip æ ¼å¼çš„æ’ä»¶åŒ…");return}const x=i.loading("æ­£åœ¨å¯¼å…¥æ’ä»¶...");try{const b=await N.importLocalPlugin(o);i.success(b.message,{id:x}),h()}catch(b){i.error(b.message||"å¯¼å…¥å¤±è´¥",{id:x})}};return s.jsxs(s.Fragment,{children:[s.jsx("title",{children:"æ’ä»¶ç®¡ç† - NapCat WebUI"}),s.jsxs("div",{className:"p-2 md:p-4 relative",children:[s.jsx(Y,{loading:u}),s.jsx(ce,{isOpen:v,onOpenChange:y,pluginId:F}),s.jsxs("div",{className:"flex mb-6 items-center gap-4",children:[s.jsx("h1",{className:"text-2xl font-bold",children:"æ’ä»¶ç®¡ç†"}),s.jsx(T,{isIconOnly:!0,className:"bg-default-100/50 hover:bg-default-200/50 text-default-700 backdrop-blur-md",radius:"full",onPress:h,children:s.jsx(Z,{size:24})}),s.jsx(T,{className:"bg-primary-100/50 hover:bg-primary-200/50 text-primary-700 backdrop-blur-md",radius:"full",startContent:s.jsx(ee,{size:18}),onPress:S,children:"å¯¼å…¥æ’ä»¶"}),s.jsx("input",{ref:m,type:"file",accept:".zip",className:"hidden",onChange:I})]}),P?s.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[400px] text-center",children:[s.jsx("div",{className:"text-6xl mb-4",children:"ğŸ“¦"}),s.jsx("h2",{className:"text-xl font-semibold text-default-700 dark:text-white/90 mb-2",children:"æ— æ’ä»¶åŠ è½½"}),s.jsx("p",{className:"text-default-500 dark:text-white/60 max-w-md",children:"æ’ä»¶ç®¡ç†å™¨æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ plugins ç›®å½•æ˜¯å¦å­˜åœ¨"})]}):k.length===0?s.jsx("div",{className:"text-default-400",children:"æš‚æ—¶æ²¡æœ‰å®‰è£…æ’ä»¶"}):s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 justify-start items-stretch gap-x-2 gap-y-4",children:k.map(t=>s.jsx(ne,{data:t,onToggleStatus:()=>R(t),onUninstall:()=>L(t),onConfig:()=>{t.status!=="active"?i.error("æœªå¯ç”¨æ’ä»¶ï¼Œæ— æ³•é…ç½®æ’ä»¶"):t.hasConfig?M(t):i.error("æ­¤æ’ä»¶æ²¡æœ‰é…ç½®å“¦")},hasConfig:!0},t.id))})]})]})}export{Fe as default};
