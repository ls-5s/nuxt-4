import{h as l,j as e}from"./codemirror-core-vkcnXJgD.js";import{b as L,k as F,s as se,V as ae}from"./index-CRxYmROf.js";import{i as re}from"./chunk-2QAN2V2R-DUfyhebH.js";import{t as le,a as ne}from"./chunk-ML27DD5T-B8jMVnkz.js";import{b as oe,a as ie}from"./chunk-5PILOUBS-0YCBWX_5.js";import{t as A}from"./chunk-6LIX6LVT-CxcHkZta.js";import{u as de,c as B,J as n}from"./react-dom-Cz0lLOn1.js";import{g as ce,h as R,a as J,e as ue,i as me}from"./index-CT80i5B1.js";import{c as I}from"./chunk-NAV3ZXLI-Cx7sjRMR.js";import{D as xe}from"./container-CayvaCdb.js";import{P as _}from"./plugin_manager-BHhkeCxq.js";import{M as T}from"./mirror_selector_modal--qHv2Iho.js";import{u as fe}from"./use-dialog-Br2F93aG.js";import"./chunk-SLABUSGS-Dy5CjS7O.js";import"./chunk-M3MASYO7-Cm5fw87L.js";import"./chunk-UX7UMZL5-D0R1-FPm.js";import"./index-CokAva9Y.js";import"./Item-CdZrGEbe.js";import"./chunk-WQVQ7P2I-BFZSGHT9.js";import"./iconBase-DqQMrcxU.js";const ge=({data:m,onInstall:N,installStatus:g="not-installed"})=>{const{name:w,version:h,author:v,description:o,tags:p,id:x,homepage:k}=m,[S,b]=l.useState(!1),y=()=>{b(!0),N().finally(()=>b(!1))},f=(()=>{switch(g){case"installed":return{text:"重新安装",icon:e.jsx(J,{size:16}),color:"default"};case"update-available":return{text:"更新",icon:e.jsx(R,{size:16}),color:"default"};default:return{text:"安装",icon:e.jsx(R,{size:16}),color:"primary"}}})(),c=k?e.jsx(A,{content:"跳转到插件主页",placement:"top",showArrow:!0,offset:8,delay:200,children:e.jsx("a",{href:k,target:"_blank",rel:"noreferrer",className:"text-inherit inline-block bg-no-repeat bg-left-bottom [background-image:repeating-linear-gradient(90deg,currentColor_0_2px,transparent_2px_5px)] [background-size:0%_2px] hover:[background-size:100%_2px] transition-[background-size] duration-200 ease-out",children:w})}):w;return e.jsx(xe,{className:"w-full max-w-[420px]",title:c,tag:e.jsxs("div",{className:"ml-auto flex items-center gap-1",children:[g==="installed"&&e.jsx(I,{color:"success",size:"sm",variant:"flat",startContent:e.jsx(ce,{size:14}),children:"已安装"}),g==="update-available"&&e.jsx(I,{color:"warning",size:"sm",variant:"flat",children:"可更新"}),e.jsxs(I,{color:"primary",size:"sm",variant:"flat",children:["v",h]})]}),enableSwitch:void 0,action:e.jsx(L,{fullWidth:!0,radius:"full",size:"sm",color:f.color,startContent:f.icon,onPress:y,isLoading:S,isDisabled:S,children:f.text}),children:e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"flex flex-col gap-1 p-3 bg-default-100/50 dark:bg-white/10 rounded-xl border border-transparent hover:border-default-200 transition-colors",children:[e.jsx("span",{className:"text-xs text-default-500 dark:text-white/50 font-medium tracking-wide",children:"作者"}),e.jsx("div",{className:"text-sm font-medium text-default-700 dark:text-white/90 truncate",children:v||"未知"})]}),e.jsxs("div",{className:"flex flex-col gap-1 p-3 bg-default-100/50 dark:bg-white/10 rounded-xl border border-transparent hover:border-default-200 transition-colors",children:[e.jsx("span",{className:"text-xs text-default-500 dark:text-white/50 font-medium tracking-wide",children:"版本"}),e.jsxs("div",{className:"text-sm font-medium text-default-700 dark:text-white/90 truncate",children:["v",h]})]}),e.jsxs("div",{className:"col-span-2 flex flex-col gap-1 p-3 bg-default-100/50 dark:bg-white/10 rounded-xl border border-transparent hover:border-default-200 transition-colors",children:[e.jsx("span",{className:"text-xs text-default-500 dark:text-white/50 font-medium tracking-wide",children:"描述"}),e.jsx("div",{className:"text-sm font-medium text-default-700 dark:text-white/90 break-words line-clamp-2 h-10 overflow-hidden",children:o||"暂无描述"})]}),x&&e.jsxs("div",{className:"flex flex-col gap-1 p-3 bg-default-100/50 dark:bg-white/10 rounded-xl border border-transparent hover:border-default-200 transition-colors",children:[e.jsx("span",{className:"text-xs text-default-500 dark:text-white/50 font-medium tracking-wide",children:"包名"}),e.jsx("div",{className:"text-sm font-medium text-default-700 dark:text-white/90 break-words line-clamp-2 h-10 overflow-hidden",children:x||"包名"})]}),p&&p.length>0&&e.jsxs("div",{className:"flex flex-col gap-1 p-3 bg-default-100/50 dark:bg-white/10 rounded-xl border border-transparent hover:border-default-200 transition-colors",children:[e.jsx("span",{className:"text-xs text-default-500 dark:text-white/50 font-medium tracking-wide",children:"标签"}),e.jsx("div",{className:"text-sm font-medium text-default-700 dark:text-white/90 truncate",children:p.slice(0,2).join(" · ")})]})]})})},he=({isEmpty:m})=>e.jsx("div",{className:B("text-default-400",{hidden:!m}),children:"暂时没有可用的插件"});function $e(){var D,V;const[m,N]=l.useState([]),[g,w]=l.useState([]),[h,v]=l.useState(!1),[o,p]=l.useState(""),[x,k]=l.useState("all"),[S,b]=l.useState(!1),y=fe(),[E,f]=l.useState(!1),[c,U]=l.useState(void 0),[W,C]=l.useState(!1),[O,P]=l.useState(null),[Q,K]=l.useState(void 0),M=async(t=!1)=>{v(!0);try{const r=await _.getPluginStoreList(t);N(r.plugins);const s=await _.getPluginList();b(s.pluginManagerNotFound),w(s.plugins||[])}catch(r){n.error(r.message)}finally{v(!1)}};l.useEffect(()=>{M()},[c]);const i=l.useMemo(()=>{let t=m;return o&&(t=t.filter(s=>{var a;return s.name.toLowerCase().includes(o.toLowerCase())||s.description.toLowerCase().includes(o.toLowerCase())||s.author.toLowerCase().includes(o.toLowerCase())||((a=s.tags)==null?void 0:a.some(d=>d.toLowerCase().includes(o.toLowerCase())))})),{all:t,official:t.filter(s=>{var a;return(a=s.tags)==null?void 0:a.includes("官方")}),tools:t.filter(s=>{var a;return(a=s.tags)==null?void 0:a.includes("工具")}),entertainment:t.filter(s=>{var a;return(a=s.tags)==null?void 0:a.includes("娱乐")}),other:t.filter(s=>{var a;return!((a=s.tags)!=null&&a.some(d=>["官方","工具","娱乐"].includes(d)))})}},[m,o]),q=t=>{const r=g.find(s=>s.id===t.id);return r?r.version!==t.version?{status:"update-available",installedVersion:r.version}:{status:"installed",installedVersion:r.version}:{status:"not-installed"}},G=l.useMemo(()=>{var t,r,s,a,d;return[{key:"all",title:"全部",count:((t=i.all)==null?void 0:t.length)||0},{key:"official",title:"官方",count:((r=i.official)==null?void 0:r.length)||0},{key:"tools",title:"工具",count:((s=i.tools)==null?void 0:s.length)||0},{key:"entertainment",title:"娱乐",count:((a=i.entertainment)==null?void 0:a.length)||0},{key:"other",title:"其它",count:((d=i.other)==null?void 0:d.length)||0}]},[i]),H=async t=>{P(t),C(!0)},X=async(t,r)=>{const s=n.loading("正在准备安装...");try{const a=localStorage.getItem(F.token);if(!a){n.error("未登录，请先登录",{id:s});return}const d=JSON.parse(a),$=new URLSearchParams({id:t});r&&$.append("mirror",r);const j=new ae.EventSourcePolyfill(`/api/Plugin/Store/Install/SSE?${$.toString()}`,{headers:{Authorization:`Bearer ${d}`,Accept:"text/event-stream"},withCredentials:!0});j.onmessage=z=>{try{const u=JSON.parse(z.data);u.error?(n.error(`安装失败: ${u.error}`,{id:s}),j.close()):u.success?(n.success("插件安装成功！",{id:s}),j.close(),M(),S&&y.confirm({title:"插件管理器未加载",content:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-default-600",children:"插件已安装成功，但插件管理器尚未加载。"}),e.jsx("p",{className:"text-sm text-default-600",children:"是否立即注册插件管理器？注册后插件才能正常运行。"})]}),confirmText:"注册插件管理器",cancelText:"稍后再说",onConfirm:async()=>{try{await _.registerPluginManager(),n.success("插件管理器注册成功"),b(!1)}catch(te){n.error("注册失败: "+te.message)}}})):u.message&&n.loading(u.message,{id:s})}catch(u){console.error("Failed to parse SSE message:",u)}},j.onerror=z=>{console.error("SSE连接出错:",z),n.error("连接中断，安装失败",{id:s}),j.close()}}catch(a){n.error(`安装失败: ${a.message||"未知错误"}`,{id:s})}},Y=()=>{if(!c)return"默认源";try{return new URL(c).hostname}catch{return c}},[Z]=de(F.backgroundImage,""),ee=!!Z;return e.jsxs(e.Fragment,{children:[e.jsx("title",{children:"插件商店 - NapCat WebUI"}),e.jsxs("div",{className:"p-2 md:p-4 relative",children:[e.jsxs("div",{className:B("sticky top-14 z-10 backdrop-blur-sm py-4 px-4 rounded-sm mb-4 -mx-2 md:-mx-4 -mt-2 md:-mt-4 transition-colors",ee?"bg-white/20 dark:bg-black/10":"bg-transparent"),children:[e.jsxs("div",{className:"flex mb-4 items-center justify-between flex-wrap gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"插件商店"}),e.jsx(L,{isIconOnly:!0,className:"bg-default-100/50 hover:bg-default-200/50 text-default-700 backdrop-blur-md",radius:"full",onPress:()=>M(!0),isLoading:h,children:e.jsx(J,{size:24})})]}),e.jsx(oe,{className:"bg-default-100/50 backdrop-blur-md shadow-sm",children:e.jsx(ie,{className:"py-2 px-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-default-500",children:"列表源:"}),e.jsx("span",{className:"text-sm font-medium",children:Y()})]}),e.jsx(A,{content:"切换列表源",children:e.jsx(L,{isIconOnly:!0,size:"sm",variant:"light",onPress:()=>f(!0),children:e.jsx(ue,{size:16})})})]})})})]}),e.jsx("div",{className:"mb-4",children:e.jsx(re,{placeholder:"搜索插件名称、描述、作者或标签...",startContent:e.jsx(me,{className:"text-default-400"}),value:o,onValueChange:p,className:"max-w-md"})}),e.jsx(le,{"aria-label":"Plugin Store Categories",className:"max-w-full",selectedKey:x,onSelectionChange:t=>k(String(t)),classNames:{tabList:"bg-white/40 dark:bg-black/20 backdrop-blur-md",cursor:"bg-white/80 dark:bg-white/10 backdrop-blur-md shadow-sm",panel:"hidden"},children:G.map(t=>e.jsx(ne,{title:`${t.title} (${t.count})`},t.key))})]}),e.jsxs("div",{className:"relative",children:[h&&e.jsx("div",{className:"absolute inset-0 bg-zinc-500/10 z-30 flex justify-center items-center backdrop-blur-sm rounded-lg",children:e.jsx(se,{size:"lg"})}),e.jsx(he,{isEmpty:!((D=i[x])!=null&&D.length)}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 justify-start items-stretch gap-x-2 gap-y-4",children:(V=i[x])==null?void 0:V.map(t=>{const r=q(t);return e.jsx(ge,{data:t,installStatus:r.status,installedVersion:r.installedVersion,onInstall:()=>H(t)},t.id)})})]})]}),e.jsx(T,{isOpen:E,onClose:()=>f(!1),onSelect:t=>{U(t)},currentMirror:c,type:"raw"}),e.jsx(T,{isOpen:W,onClose:()=>{C(!1),P(null)},onSelect:t=>{K(t),O&&(C(!1),X(O.id,t),P(null))},currentMirror:Q,type:"file"})]})}export{$e as default};
